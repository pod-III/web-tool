<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiSplitter.io - English 1 Batam</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'e1-pink': '#FF6B95',   // Playful
                        'e1-orange': '#FF8C42', // Energy
                        'e1-green': '#00E676',  // Success
                        'e1-blue': '#2979FF',   // Logic
                        'e1-dark': '#1e293b',   // Borders/Text
                        'e1-chalk': '#f8fafc',  // Backgrounds
                    },
                    fontFamily: {
                        headings: ['Fredoka', 'sans-serif'],
                        body: ['Nunito', 'sans-serif'],
                    },
                    // Neo-Brutalism Shadows
                    boxShadow: {
                        'neo': '4px 4px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-sm': '2px 2px 0px 0px rgba(30, 41, 59, 1)',
                        'neo-pressed': 'inset 2px 2px 0px 0px rgba(30, 41, 59, 1)',
                    },
                    borderWidth: { '3': '3px' }
                }
            }
        }
    </script>

    <style>
        /* Graph Paper Background Pattern */
        body {
            background-color: #f8fafc;
            background-image: 
                linear-gradient(rgba(30, 41, 59, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 41, 59, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .dark body {
            background-color: #0f172a;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        }

        /* Custom Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #1e293b;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 2px 2px 0px 0px rgba(30,41,59,1);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px;
            cursor: pointer; background: #cbd5e1;
            border-radius: 4px; border: 1px solid #1e293b;
        }

        /* Mode Toggle Active State */
        .mode-active {
            background-color: #1e293b !important;
            color: #00E676 !important; 
            box-shadow: inset 2px 2px 0px 0px rgba(0, 0, 0, 0.5) !important;
            transform: translate(1px, 1px);
        }
        
        /* Preview Cut Handle badges */
        .cut-handle {
            position: absolute;
            width: 20px; height: 20px;
            background-color: white;
            border: 2px solid #1e293b;
            border-radius: 50%;
            font-size: 10px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            z-index: 30;
            transform: translate(-50%, -50%);
            box-shadow: 2px 2px 0px 0px rgba(30,41,59,0.5);
        }
    </style>
</head>

<body class="font-body text-e1-dark flex flex-col min-h-screen transition-colors duration-200">

    <nav class="w-full bg-white border-b-4 border-e1-dark p-4 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-e1-pink p-2 rounded-xl border-2 border-e1-dark shadow-neo-sm">
                    <i data-lucide="scissors" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="font-headings text-2xl font-bold tracking-wide">MultiSplitter<span class="text-e1-blue">.io</span></h1>
            </div>
            <button onclick="toggleDarkMode()" class="bg-e1-dark text-white p-2 rounded-xl border-2 border-e1-dark shadow-neo-sm hover:translate-y-[-1px] transition-transform" title="Toggle Dark Mode">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
    </nav>

    <main class="flex-grow max-w-6xl mx-auto w-full p-4 lg:p-8 flex flex-col lg:flex-row gap-8">
        
        <aside class="w-full lg:w-1/3 flex flex-col gap-6">
            
            <div class="bg-white p-6 rounded-2xl border-4 border-e1-dark shadow-neo relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-e1-orange text-white text-xs font-bold px-3 py-1 border-l-2 border-b-2 border-e1-dark rounded-bl-xl font-headings">STEP 1</div>
                <h2 class="font-headings text-xl font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="upload-cloud" class="w-5 h-5 text-e1-orange"></i> Upload
                </h2>
                
                <div class="border-3 border-dashed border-slate-300 rounded-xl bg-slate-50 h-24 flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 hover:border-e1-blue transition-colors relative group">
                    <input type="file" id="fileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="flex items-center gap-2 group-hover:scale-105 transition-transform">
                        <i data-lucide="image-plus" class="w-6 h-6 text-e1-blue"></i>
                        <span class="font-bold text-slate-500 text-sm">Select Image</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl border-4 border-e1-dark shadow-neo relative opacity-50 pointer-events-none transition-all duration-300" id="configCard">
                <div class="absolute top-0 right-0 bg-e1-blue text-white text-xs font-bold px-3 py-1 border-l-2 border-b-2 border-e1-dark rounded-bl-xl font-headings">STEP 2</div>
                <h2 class="font-headings text-xl font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="sliders" class="w-5 h-5 text-e1-green"></i> Settings
                </h2>

                <div class="bg-slate-100 p-1 rounded-xl border-2 border-e1-dark flex mb-6 shadow-inner">
                    <button onclick="setAppMode('equal')" id="mode-equal" class="flex-1 py-2 rounded-lg font-bold text-sm transition-all mode-active">Equal Grid</button>
                    <button onclick="setAppMode('custom')" id="mode-custom" class="flex-1 py-2 rounded-lg font-bold text-sm transition-all text-slate-500 hover:bg-white">Custom Multi</button>
                </div>

                <div id="equalControls" class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                         <span class="w-2 h-2 rounded-full bg-e1-pink"></span>
                         <p class="text-xs text-slate-500 font-bold">AUTO-DIVIDE GRID</p>
                    </div>
                   
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="font-bold text-sm">Horizontal Rows</label>
                            <span id="eqRowsVal" class="font-headings font-bold bg-e1-dark text-white px-2 rounded text-sm">2</span>
                        </div>
                        <input type="range" id="eqRowsInput" min="1" max="10" value="2" class="w-full accent-e1-blue">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="font-bold text-sm">Vertical Columns</label>
                            <span id="eqColsVal" class="font-headings font-bold bg-e1-dark text-white px-2 rounded text-sm">2</span>
                        </div>
                        <input type="range" id="eqColsInput" min="1" max="10" value="2" class="w-full accent-e1-pink">
                    </div>
                </div>

                <div id="customControls" class="space-y-6 hidden">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-2 h-2 rounded-full bg-e1-orange"></span>
                        <p class="text-xs text-slate-500 font-bold">MANUAL CUT LINES</p>
                   </div>
                    
                    <div class="bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                        <div class="flex items-center justify-between mb-3">
                            <label class="font-bold text-sm text-e1-dark flex items-center gap-2"><i data-lucide="rows" class="w-4 h-4 text-e1-blue"></i> Row Count</label>
                            <div class="flex items-center gap-1">
                                <button onclick="adjustCustomCount('row', -1)" class="w-7 h-7 bg-white border-2 border-e1-dark rounded hover:bg-slate-100 font-bold">-</button>
                                <span id="custRowCount" class="font-headings font-bold text-lg w-6 text-center">2</span>
                                <button onclick="adjustCustomCount('row', 1)" class="w-7 h-7 bg-white border-2 border-e1-dark rounded hover:bg-slate-100 font-bold">+</button>
                            </div>
                        </div>
                        <div id="rowSlidersContainer" class="space-y-3 pl-2 border-l-2 border-e1-blue"></div>
                    </div>

                    <div class="bg-pink-50/50 p-3 rounded-xl border border-pink-100">
                        <div class="flex items-center justify-between mb-3">
                            <label class="font-bold text-sm text-e1-dark flex items-center gap-2"><i data-lucide="columns" class="w-4 h-4 text-e1-pink"></i> Col Count</label>
                            <div class="flex items-center gap-1">
                                <button onclick="adjustCustomCount('col', -1)" class="w-7 h-7 bg-white border-2 border-e1-dark rounded hover:bg-slate-100 font-bold">-</button>
                                <span id="custColCount" class="font-headings font-bold text-lg w-6 text-center">2</span>
                                <button onclick="adjustCustomCount('col', 1)" class="w-7 h-7 bg-white border-2 border-e1-dark rounded hover:bg-slate-100 font-bold">+</button>
                            </div>
                        </div>
                        <div id="colSlidersContainer" class="space-y-3 pl-2 border-l-2 border-e1-pink"></div>
                    </div>
                </div>

                <button id="downloadBtn" class="w-full mt-8 bg-e1-green text-e1-dark font-headings font-bold text-lg py-3 px-4 rounded-xl border-2 border-e1-dark shadow-neo hover:translate-y-[-2px] hover:shadow-lg active:translate-y-[2px] active:shadow-none transition-all flex items-center justify-center gap-2 group">
                    <i data-lucide="download" class="group-hover:animate-bounce"></i> Download ZIP
                </button>
                <p id="statusMsg" class="text-center text-xs font-bold text-e1-blue mt-2 h-4"></p>
            </div>
        </aside>

        <section class="w-full lg:w-2/3">
            <div class="bg-white p-2 rounded-2xl border-4 border-e1-dark shadow-neo h-full min-h-[500px] flex flex-col relative">
                <div class="absolute top-4 left-4 z-10 bg-white/90 backdrop-blur border-2 border-e1-dark px-3 py-1 rounded-lg shadow-sm">
                    <h2 class="font-headings text-sm font-bold flex items-center gap-2">
                        <i data-lucide="eye" class="text-e1-blue w-4 h-4"></i> Live Preview
                    </h2>
                </div>

                <div class="flex-grow bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden relative m-1 p-8" id="previewContainer">
                    
                    <div id="emptyState" class="text-center p-6 animate-pulse">
                        <div class="inline-block bg-white p-4 rounded-full border-2 border-e1-dark shadow-neo mb-4">
                            <i data-lucide="layout-grid" class="w-12 h-12 text-slate-300"></i>
                        </div>
                        <p class="text-slate-400 font-bold font-headings text-lg">Waiting for image...</p>
                    </div>

                    <canvas id="mainCanvas" class="hidden shadow-2xl border-2 border-e1-dark relative z-10"></canvas>
                    
                    <div id="gridOverlay" class="absolute pointer-events-none z-20"></div>
                </div>
            </div>
        </section>

    </main>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // --- GLOBAL STATE ---
        const state = {
            currentImage: null,
            mode: 'equal', // 'equal' | 'custom'
            customCounts: {
                row: 2, // Default 2 rows (1 cut)
                col: 2  // Default 2 cols (1 cut)
            }
        };

        // --- DOM ELEMENTS ---
        const elements = {
            fileInput: document.getElementById('fileInput'),
            configCard: document.getElementById('configCard'),
            emptyState: document.getElementById('emptyState'),
            mainCanvas: document.getElementById('mainCanvas'),
            gridOverlay: document.getElementById('gridOverlay'),
            previewContainer: document.getElementById('previewContainer'),
            statusMsg: document.getElementById('statusMsg'),
            downloadBtn: document.getElementById('downloadBtn'),
            // Mode UI
            modeEqualBtn: document.getElementById('mode-equal'),
            modeCustomBtn: document.getElementById('mode-custom'),
            equalControls: document.getElementById('equalControls'),
            customControls: document.getElementById('customControls'),
            // Inputs
            eqRowsInput: document.getElementById('eqRowsInput'),
            eqColsInput: document.getElementById('eqColsInput'),
            eqRowsVal: document.getElementById('eqRowsVal'),
            eqColsVal: document.getElementById('eqColsVal'),
            // Custom Inputs
            custRowCount: document.getElementById('custRowCount'),
            custColCount: document.getElementById('custColCount'),
            rowSliders: document.getElementById('rowSlidersContainer'),
            colSliders: document.getElementById('colSlidersContainer'),
        };

        const ctx = elements.mainCanvas.getContext('2d');

        // --- EVENT LISTENERS ---
        
        elements.fileInput.addEventListener('change', handleUpload);
        elements.downloadBtn.addEventListener('click', generateZip);
        
        // Equal Inputs Listeners
        elements.eqRowsInput.addEventListener('input', (e) => { 
            elements.eqRowsVal.innerText = e.target.value; 
            renderPreview(); 
        });
        elements.eqColsInput.addEventListener('input', (e) => { 
            elements.eqColsVal.innerText = e.target.value; 
            renderPreview(); 
        });

        // Resize Listener
        window.addEventListener('resize', () => { 
            if(state.currentImage) renderPreview(); 
        });


        // --- CORE FUNCTIONS ---

        /**
         * Handles image file reading and initializes the UI
         */
        function handleUpload(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.onload = () => {
                    state.currentImage = img;
                    // Enable UI
                    elements.configCard.classList.remove('opacity-50', 'pointer-events-none');
                    elements.emptyState.classList.add('hidden');
                    elements.mainCanvas.classList.remove('hidden');
                    // Init Custom Sliders
                    rebuildCustomSliders('row');
                    rebuildCustomSliders('col');
                    // Draw
                    renderPreview();
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }

        /**
         * Switches between 'Equal' and 'Custom' modes
         */
        window.setAppMode = function(mode) {
            state.mode = mode;
            
            // Toggle Button Styles
            if(mode === 'equal') {
                elements.modeEqualBtn.classList.add('mode-active');
                elements.modeCustomBtn.classList.remove('mode-active');
                elements.equalControls.classList.remove('hidden');
                elements.customControls.classList.add('hidden');
            } else {
                elements.modeCustomBtn.classList.add('mode-active');
                elements.modeEqualBtn.classList.remove('mode-active');
                elements.customControls.classList.remove('hidden');
                elements.equalControls.classList.add('hidden');
            }
            renderPreview();
        };

        /**
         * Increases or decreases custom row/col counts
         */
        window.adjustCustomCount = function(type, delta) {
            // Limit between 1 and 10
            state.customCounts[type] = Math.max(1, Math.min(10, state.customCounts[type] + delta));
            
            // Update Text
            if(type === 'row') elements.custRowCount.innerText = state.customCounts[type];
            else elements.custColCount.innerText = state.customCounts[type];

            // Rebuild sliders for that type
            rebuildCustomSliders(type);
            renderPreview();
        };

        /**
         * Dynamically creates range sliders for custom cuts.
         * Uses Smart Defaults: If you ask for 3 rows, it sets sliders at 33% and 66%.
         */
        function rebuildCustomSliders(type) {
            const container = type === 'row' ? elements.rowSliders : elements.colSliders;
            container.innerHTML = '';
            
            const count = state.customCounts[type];
            const numCuts = count - 1;

            if (numCuts === 0) {
                container.innerHTML = `<p class="text-xs text-slate-400 italic">No ${type === 'row' ? 'Horizontal' : 'Vertical'} cuts.</p>`;
                return;
            }

            for(let i = 0; i < numCuts; i++) {
                // Calculate Even Spacing Percentage
                const defaultPercent = Math.floor(((i + 1) / count) * 100);
                
                const wrapper = document.createElement('div');
                const labelColor = type === 'row' ? 'text-e1-blue' : 'text-e1-pink';
                
                wrapper.innerHTML = `
                    <div class="flex justify-between text-xs font-bold text-slate-500 mb-1">
                        <span class="${labelColor}">${type === 'row' ? 'Row' : 'Col'} Cut #${i+1}</span>
                        <span id="${type}Percent_${i}">${defaultPercent}%</span>
                    </div>
                `;

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = '1';
                slider.max = '99';
                slider.value = defaultPercent;
                slider.className = `w-full ${type === 'row' ? 'accent-e1-blue' : 'accent-e1-pink'}`;
                
                // Add listener to update percent text and re-render preview
                slider.addEventListener('input', (e) => {
                    document.getElementById(`${type}Percent_${i}`).innerText = e.target.value + '%';
                    renderPreview();
                });

                wrapper.appendChild(slider);
                container.appendChild(wrapper);
            }
        }

        /**
         * Fetches all slider values, sorts them, and returns logical cut points (0-100)
         * Sorting is crucial because a user might drag "Cut 2" above "Cut 1".
         */
        function getCustomCutPercentages() {
            const getVals = (container) => {
                const inputs = Array.from(container.querySelectorAll('input'));
                const values = inputs.map(input => parseInt(input.value));
                return values.sort((a, b) => a - b);
            };

            return {
                rows: getVals(elements.rowSliders),
                cols: getVals(elements.colSliders)
            };
        }

        /**
         * Renders the Image and the Grid Overlay
         */
        function renderPreview() {
            if(!state.currentImage) return;

            // 1. Calculate Scale to fit container
            const boxW = elements.previewContainer.clientWidth - 40;
            const boxH = elements.previewContainer.clientHeight - 40;
            const img = state.currentImage;
            const scale = Math.min(boxW / img.width, boxH / img.height);
            
            const dispW = img.width * scale;
            const dispH = img.height * scale;

            // 2. Draw Image to Canvas
            elements.mainCanvas.width = dispW;
            elements.mainCanvas.height = dispH;
            ctx.drawImage(img, 0, 0, dispW, dispH);

            // 3. Setup Overlay Dimensions
            const overlay = elements.gridOverlay;
            overlay.style.width = `${dispW}px`;
            overlay.style.height = `${dispH}px`;
            overlay.style.left = 'auto'; // Flexbox centers it
            overlay.style.top = 'auto';
            overlay.innerHTML = ''; // Clear previous lines

            // 4. Draw Lines based on Mode
            if(state.mode === 'equal') {
                drawEqualGrid(dispW, dispH);
            } else {
                drawCustomGrid(dispW, dispH);
            }
        }

        function drawEqualGrid(w, h) {
            const rows = parseInt(elements.eqRowsInput.value);
            const cols = parseInt(elements.eqColsInput.value);
            
            const rowH = h / rows;
            const colW = w / cols;

            // Draw Verticals
            for(let i=1; i<cols; i++) createLine(i*colW, 0, 2, h, '#FF6B95', false);
            // Draw Horizontals
            for(let i=1; i<rows; i++) createLine(0, i*rowH, w, 2, '#FF6B95', false);
        }

        function drawCustomGrid(w, h) {
            const { rows, cols } = getCustomCutPercentages();

            // Draw Rows (Blue)
            rows.forEach((pct, idx) => {
                const y = (pct/100) * h;
                createLine(0, y, w, 3, '#2979FF', true, idx+1);
            });

            // Draw Cols (Pink)
            cols.forEach((pct, idx) => {
                const x = (pct/100) * w;
                createLine(x, 0, 3, h, '#FF6B95', true, idx+1);
            });
        }

        /**
         * Helper to create DOM elements for lines
         */
        function createLine(x, y, w, h, color, hasBadge, index) {
            const line = document.createElement('div');
            line.className = 'absolute shadow-sm pointer-events-none';
            line.style.backgroundColor = color;
            line.style.left = `${x}px`;
            line.style.top = `${y}px`;
            line.style.width = `${w}px`;
            line.style.height = `${h}px`;
            elements.gridOverlay.appendChild(line);

            if(hasBadge) {
                const badge = document.createElement('div');
                badge.className = 'cut-handle';
                badge.style.left = w > h ? '50%' : `${x}px`; // Center if horizontal line, else X pos
                badge.style.top = h > w ? '50%' : `${y}px`;  // Center if vertical line, else Y pos
                badge.style.borderColor = color;
                badge.style.color = color;
                badge.innerText = index;
                elements.gridOverlay.appendChild(badge);
            }
        }

        // --- ZIP GENERATION ---

        async function generateZip() {
            if(!state.currentImage) return;

            // UI Feedback
            elements.statusMsg.innerText = "Slicing image...";
            elements.downloadBtn.disabled = true;
            elements.downloadBtn.classList.add('opacity-70', 'cursor-not-allowed');

            const zip = new JSZip();
            const img = state.currentImage;
            const w = img.width;
            const h = img.height;

            // 1. Determine Cut Coordinates (in Pixels)
            let yStops = [], xStops = [];

            if(state.mode === 'equal') {
                const r = parseInt(elements.eqRowsInput.value);
                const c = parseInt(elements.eqColsInput.value);
                for(let i=0; i<=r; i++) yStops.push((i/r) * h);
                for(let i=0; i<=c; i++) xStops.push((i/c) * w);
            } else {
                const { rows, cols } = getCustomCutPercentages();
                // Add 0 (start) and 100 (end) to the cut points
                yStops = [0, ...rows.map(p => (p/100)*h), h];
                xStops = [0, ...cols.map(p => (p/100)*w), w];
            }

            // 2. Perform Slicing on Temporary Canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Iterate Rows then Cols
            for(let r=0; r < yStops.length - 1; r++) {
                for(let c=0; c < xStops.length - 1; c++) {
                    const y = yStops[r];
                    const height = yStops[r+1] - y;
                    const x = xStops[c];
                    const width = xStops[c+1] - x;

                    // Safety check for tiny slivers
                    if(width < 1 || height < 1) continue;

                    canvas.width = width;
                    canvas.height = height;
                    ctx.clearRect(0,0,width,height);
                    
                    // Draw portion of original image to temp canvas
                    ctx.drawImage(img, x, y, width, height, 0, 0, width, height);

                    // Convert to BLOB and add to ZIP
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    zip.file(`slice_row${r+1}_col${c+1}.png`, blob);
                }
            }

            // 3. Generate and Save ZIP
            zip.generateAsync({type:"blob"}).then((content) => {
                saveAs(content, "multisplitter_images.zip");
                
                // Reset UI Feedback
                elements.statusMsg.innerText = "Download Ready!";
                elements.downloadBtn.disabled = false;
                elements.downloadBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                setTimeout(() => elements.statusMsg.innerText = "", 3000);
            });
        }

        // Dark Mode Toggle
        window.toggleDarkMode = function() {
            document.documentElement.classList.toggle('dark');
        }

    </script>
</body>
</html>